# コードレビュー: [タスク名]

## メタ情報
- **タスクID**: YYYY-MM-DD_[short-name]
- **レビュー日**: YYYY-MM-DD
- **レビュアー**: [レビュアー名またはAI]
- **対象ブランチ**: `feature/xxx`
- **ベースブランチ**: `main`

---

## レビューサマリー

### 全体評価
- [ ] **承認（Approved）** - マージ可能
- [ ] **条件付き承認（Approved with Comments）** - 軽微な修正後にマージ可
- [ ] **変更要求（Changes Requested）** - 修正必須

### 指摘件数
| 重大度 | 件数 | 対応状況 |
|--------|------|----------|
| Blocker（致命的） | 0 | ✅ 全て対応済み |
| High（重要） | 0 | ✅ 全て対応済み |
| Medium（推奨） | 0 | 🔶 一部対応済み |
| Low（軽微） | 0 | 🔶 一部対応済み |
| Info（情報） | 0 | - |

---

## 1. セキュリティレビュー（最優先）

### 🔒 認証・認可
- [ ] **チェック項目**: 認証が必要なエンドポイントに適切な保護がある
- [ ] **チェック項目**: 認可ロジックが正しく実装されている（ユーザーが自分のデータのみアクセス可能）
- [ ] **チェック項目**: セッション管理が適切（タイムアウト、トークンリフレッシュ）

**指摘事項:**
<!--
該当する場合のみ記載
例:
- [Blocker] `/api/instagram/accounts/` が認証なしでアクセス可能
  - ファイル: `backend/instagram/views.py:45`
  - 修正案: `@permission_classes([IsAuthenticated])` を追加
-->

---

### 🛡️ 入力バリデーション
- [ ] **チェック項目**: 全てのユーザー入力がバリデーションされている
- [ ] **チェック項目**: SQLインジェクション対策（ORMの適切な使用）
- [ ] **チェック項目**: XSS対策（エスケープ処理）
- [ ] **チェック項目**: CSRF対策（フロントエンド↔バックエンド）

**指摘事項:**
<!--
例:
- [High] Instagram username が未検証でクエリに使用されている
  - ファイル: `backend/instagram/services.py:123`
  - リスク: SQLインジェクションの可能性
  - 修正案: Serializerでバリデーション追加
-->

---

### 🔐 機密情報の取り扱い
- [ ] **チェック項目**: シークレット（API key, password等）がハードコードされていない
- [ ] **チェック項目**: ログに機密情報（トークン、パスワード等）が出力されていない
- [ ] **チェック項目**: 環境変数が適切に使用されている
- [ ] **チェック項目**: Instagram セッションファイルが `.gitignore` に含まれている

**指摘事項:**
<!--
例:
- [Blocker] Google Client Secret がコードに直接記載されている
  - ファイル: `frontend/src/config.ts:12`
  - 修正案: 環境変数 `GOOGLE_CLIENT_SECRET` を使用
-->

---

### 🌐 CORS・HTTPS
- [ ] **チェック項目**: CORS設定が適切（許可ドメインが限定されている）
- [ ] **チェック項目**: 本番環境でHTTPSが強制されている
- [ ] **チェック項目**: Secure Cookie が使用されている（本番環境）

**指摘事項:**

---

## 2. アーキテクチャ・設計レビュー

### 📐 設計パターン
- [ ] **チェック項目**: 既存のコードパターンと一貫性がある
- [ ] **チェック項目**: Single Responsibility Principle が守られている
- [ ] **チェック項目**: DRY原則（コードの重複がない）
- [ ] **チェック項目**: 適切な抽象化レベル

**指摘事項:**
<!--
例:
- [Medium] 同じバリデーションロジックが3箇所に重複
  - ファイル: `frontend/src/components/A.tsx:45`, `B.tsx:67`, `C.tsx:89`
  - 修正案: 共通ユーティリティ関数に抽出
-->

---

### 🔄 状態管理
- [ ] **チェック項目**: 状態管理が適切（Context API、Redux、Zustand等）
- [ ] **チェック項目**: 不要なグローバル状態がない
- [ ] **チェック項目**: 副作用（API呼び出し）が適切な場所で実行されている

**指摘事項:**

---

### 🗄️ データベース
- [ ] **チェック項目**: マイグレーションファイルが作成されている
- [ ] **チェック項目**: インデックスが適切に設定されている（パフォーマンス考慮）
- [ ] **チェック項目**: N+1クエリ問題がない（`select_related`, `prefetch_related`）
- [ ] **チェック項目**: トランザクションが適切に使用されている

**指摘事項:**

---

## 3. コード品質レビュー

### ✨ 可読性
- [ ] **チェック項目**: 変数名・関数名が意図を明確に表している
- [ ] **チェック項目**: 複雑なロジックにコメントがある
- [ ] **チェック項目**: マジックナンバーが定数化されている
- [ ] **チェック項目**: ファイルサイズが適切（1ファイル300行以内を推奨）

**指摘事項:**
<!--
例:
- [Low] 変数名 `data` が汎用的すぎる
  - ファイル: `frontend/src/hooks/useInstagram.tsx:23`
  - 修正案: `instagramAccounts` など具体的な名前に変更
-->

---

### 🧪 テストカバレッジ
- [ ] **チェック項目**: 新規機能にユニットテストがある
- [ ] **チェック項目**: エッジケースがテストされている
- [ ] **チェック項目**: モック・スタブが適切に使用されている
- [ ] **チェック項目**: テストが独立している（実行順序に依存しない）

**指摘事項:**
<!--
例:
- [High] `handleInstagramLogin` 関数にテストがない
  - ファイル: `frontend/src/hooks/useInstagram.tsx:45`
  - 修正案: エラーケースを含むユニットテスト追加
-->

---

### 🚨 エラーハンドリング
- [ ] **チェック項目**: 全てのAPI呼び出しにエラーハンドリングがある
- [ ] **チェック項目**: ユーザーにわかりやすいエラーメッセージが表示される
- [ ] **チェック項目**: ログに十分な情報が記録される（デバッグ用）
- [ ] **チェック項目**: エラー時のリトライロジックが適切（該当する場合）

**指摘事項:**

---

### ⚡ パフォーマンス
- [ ] **チェック項目**: 不要な再レンダリングがない（React.memo、useMemo等）
- [ ] **チェック項目**: 画像の最適化（サイズ、フォーマット）
- [ ] **チェック項目**: 遅延ローディング（Lazy loading）の使用（該当する場合）
- [ ] **チェック項目**: データベースクエリの最適化

**指摘事項:**

---

## 4. 互換性・破壊的変更レビュー

### 🔄 後方互換性
- [ ] **チェック項目**: 既存APIエンドポイントのシグネチャが変更されていない
- [ ] **チェック項目**: データベーススキーマ変更が既存データと互換性がある
- [ ] **チェック項目**: 環境変数の追加が既存設定を壊さない

**指摘事項:**
<!--
例:
- [Blocker] `/api/auth/me/` のレスポンス形式が変更されている
  - 既存フロントエンドが動作しなくなる可能性
  - 修正案: バージョニング（`/api/v2/auth/me/`）を検討
-->

---

### 📦 依存関係
- [ ] **チェック項目**: 新規依存パッケージに脆弱性がない
- [ ] **チェック項目**: パッケージバージョンが固定されている（`package-lock.json`, `requirements.txt`）
- [ ] **チェック項目**: 不要な依存が削除されている

**指摘事項:**

---

## 5. ドキュメント・運用レビュー

### 📚 ドキュメント
- [ ] **チェック項目**: README.md が更新されている（新機能追加時）
- [ ] **チェック項目**: CLAUDE.md が更新されている（設計変更時）
- [ ] **チェック項目**: API仕様が文書化されている（新規エンドポイント）
- [ ] **チェック項目**: 環境変数が `.env.example` に追加されている

**指摘事項:**

---

### 🚀 デプロイ・運用
- [ ] **チェック項目**: マイグレーション手順が明確
- [ ] **チェック項目**: ロールバックプランがある
- [ ] **チェック項目**: モニタリング・ログが適切に設定されている
- [ ] **チェック項目**: デプロイ前の確認事項が明確

**指摘事項:**

---

## 6. TikTok Story Creator 固有のチェック項目

### 🤖 AI APIキー管理
- [ ] **チェック項目**: OpenAI APIキー (`sk-...`) が環境変数から取得されている
- [ ] **チェック項目**: Anthropic Claude APIキー (`sk-ant-...`) が環境変数から取得されている
- [ ] **チェック項目**: ElevenLabs APIキーがハードコードされていない
- [ ] **チェック項目**: Google API認証情報（service account JSON）がコミットされていない

**指摘事項:**

---

### 🎬 動画生成サービス認証情報
- [ ] **チェック項目**: Google Veo API認証情報が適切に管理されている
- [ ] **チェック項目**: OpenAI Sora APIキーが環境変数から取得されている
- [ ] **チェック項目**: Kling AI, Runway, Pika Labs等の認証情報が安全に管理されている
- [ ] **チェック項目**: FFmpeg処理で外部入力が適切にサニタイズされている（コマンドインジェクション対策）

**指摘事項:**

---

### 🗄️ データベース・ストレージ
- [ ] **チェック項目**: PostgreSQL接続情報が環境変数から取得されている
- [ ] **チェック項目**: データベースパスワードがハードコードされていない
- [ ] **チェック項目**: Cloud Storage認証情報が適切に管理されている
- [ ] **チェック項目**: 動画ファイルのパスにディレクトリトラバーサルの脆弱性がない

**指摘事項:**

---

### 🎥 動画処理セキュリティ
- [ ] **チェック項目**: FFmpegコマンド実行時にシェルインジェクションのリスクがない
- [ ] **チェック項目**: ユーザー入力が動画ファイル名に使用される場合、適切にサニタイズされている
- [ ] **チェック項目**: 一時ファイルが適切にクリーンアップされている
- [ ] **チェック項目**: 動画生成時のリソース制限が設定されている（無制限実行防止）

**指摘事項:**

---

### 🐳 Docker環境
- [ ] **チェック項目**: Dockerfileが本番環境に対応している
- [ ] **チェック項目**: docker-compose.yml が最新の環境変数を反映している
- [ ] **チェック項目**: マルチステージビルドが適切（イメージサイズ最小化）
- [ ] **チェック項目**: FFmpeg等の大きな依存関係が効率的にインストールされている

**指摘事項:**

---

## 7. Linter・Formatter・型チェック

### 🔍 自動チェック結果
```bash
# フロントエンド
cd frontend
npm run lint        # ESLint結果
npm run format      # Prettier結果
npm run type-check  # TypeScript型チェック

# バックエンド
cd backend
black --check .     # Black結果
```

**指摘事項:**
<!--
例:
- [Low] ESLint警告が3件
  - ファイル: `frontend/src/components/Header.tsx`
  - 内容: unused import
  - 修正: 不要なimportを削除
-->

---

## 8. 詳細指摘リスト

### Blocker（致命的 - 必ず修正）
<!--
例:
#### B-01: 認証なしでアクセス可能なエンドポイント
- **ファイル**: `backend/instagram/views.py:45`
- **問題**: `/api/instagram/accounts/` が認証なしでアクセス可能
- **影響**: 全ユーザーのInstagramアカウント情報が漏洩する
- **修正案**:
  ```python
  @permission_classes([IsAuthenticated])
  class InstagramAccountViewSet(viewsets.ModelViewSet):
      # ...
  ```
- **対応状況**: ⬜ 未対応 / ✅ 対応済み
-->

---

### High（重要 - 優先的に修正）
<!--
例:
#### H-01: 未バリデーションの入力値
- **ファイル**: `frontend/src/components/InstagramForm.tsx:67`
- **問題**: Instagram username が未検証で送信されている
- **影響**: 不正な値でエラーが発生する可能性
- **修正案**:
  ```typescript
  const validateUsername = (username: string) => {
    if (!/^[a-zA-Z0-9._]{1,30}$/.test(username)) {
      throw new Error('Invalid Instagram username');
    }
  };
  ```
- **対応状況**: ⬜ 未対応 / ✅ 対応済み
-->

---

### Medium（推奨 - できれば修正）
<!--
例:
#### M-01: コードの重複
- **ファイル**: `frontend/src/components/A.tsx:45`, `B.tsx:67`
- **問題**: 同じバリデーションロジックが重複
- **影響**: 保守性の低下
- **修正案**: 共通ユーティリティ関数 `validateInstagramAccount()` を作成
- **対応状況**: ⬜ 未対応 / ✅ 対応済み
-->

---

### Low（軽微 - 時間があれば修正）
<!--
例:
#### L-01: 変数名が不明瞭
- **ファイル**: `frontend/src/hooks/useInstagram.tsx:23`
- **問題**: 変数名 `data` が汎用的すぎる
- **影響**: 可読性の低下
- **修正案**: `instagramAccounts` など具体的な名前に変更
- **対応状況**: ⬜ 未対応 / ✅ 対応済み
-->

---

### Info（情報共有）
<!--
例:
#### I-01: パフォーマンス最適化の余地
- **ファイル**: `frontend/src/components/InstagramList.tsx`
- **内容**: React.memoを使うとレンダリング回数を減らせる可能性
- **優先度**: 低（現状のパフォーマンスで問題なし）
-->

---

## 9. 変更ファイル一覧

### 変更されたファイル
```bash
git diff --name-only main...feature/xxx
```

```
frontend/src/lib/authContext.tsx
frontend/src/app/login/page.tsx
.env.example
prompts/task_template.md
prompts/review_template.md
```

---

## 10. テスト実行結果

### ユニットテスト
```bash
# フロントエンド
cd frontend && npm run test

# バックエンド
cd backend && python manage.py test
```

**結果:**
```
✅ All tests passed (XX tests)
または
❌ X tests failed
```

---

### 統合テスト
```bash
npm run test:integration
```

**結果:**

---

### E2Eテスト
```bash
npm run test:e2e
```

**結果:**

---

## 11. レビュアーコメント

### 総評
<!--
このPRの全体的な評価と感想
- 良かった点
- 改善が必要な点
- 次回に向けた提案
-->

### 承認条件
<!--
マージ承認の条件
例:
- [ ] Blocker指摘を全て修正
- [ ] High指摘のうち H-01, H-02 を修正
- [ ] ユニットテストが全て通る
-->

---

## 12. 修正履歴

### 第1回レビュー（YYYY-MM-DD）
- Blocker: 2件 → 0件 ✅
- High: 3件 → 1件 🔶
- Medium: 5件 → 3件 🔶

### 第2回レビュー（YYYY-MM-DD）
- Blocker: 0件 ✅
- High: 1件 → 0件 ✅
- Medium: 3件 → 1件 🔶

### 最終承認（YYYY-MM-DD）
- 全ての Blocker/High 指摘に対応済み ✅
- レビュアー承認 ✅
- マージ可能 ✅

---

## 13. 参考資料

### レビュー基準
- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [Google TypeScript Style Guide](https://google.github.io/styleguide/tsguide.html)
- [Django Best Practices](https://docs.djangoproject.com/en/stable/topics/best-practices/)

### プロジェクト固有ガイド
- [CLAUDE.md](../CLAUDE.md)
- [frontend/AGENTS.md](../frontend/AGENTS.md)
- [backend/AGENTS.md](../backend/AGENTS.md)

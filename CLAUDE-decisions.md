# CLAUDE - Architecture Decision Records (ADR)

**最終更新**: 2026-01-05
**プロジェクト**: TikTok Story Creator (ToC)

このファイルは、プロジェクトにおける重要なアーキテクチャ決定を記録します。

---

## ADRフォーマット

各ADRは以下の形式で記録：

- **ADR-XXX**: タイトル
- **ステータス**: 承認済み | 検討中 | 廃止 | 保留
- **日付**: YYYY-MM-DD
- **コンテキスト**: 決定が必要となった背景
- **決定事項**: 何を決定したか
- **結果**: メリット・デメリット
- **代替案**: 検討した他の選択肢

---

## 目次

- [ADR-001: 手動実行トリガーの採用](#adr-001-手動実行トリガーの採用)
- [ADR-002: マルチプロバイダー対応アーキテクチャ](#adr-002-マルチプロバイダー対応アーキテクチャ)
- [ADR-003: PostgreSQL データベースの選定](#adr-003-postgresql-データベースの選定)
- [ADR-004: 手順書ベースのAIエージェント設計](#adr-004-手順書ベースのaiエージェント設計)
- [ADR-005: Docker優先ワークフロー](#adr-005-docker優先ワークフロー)
- [ADR-006: Python 3.11+ の採用](#adr-006-python-311-の採用)
- [ADR-007: SQLAlchemy ORM の採用](#adr-007-sqlalchemy-orm-の採用)
- [ADR-008: YAML設定ファイルの使用](#adr-008-yaml設定ファイルの使用)

---

## ADR-001: 手動実行トリガーの採用

**ステータス**: 承認済み
**日付**: 2026-01-05
**決定者**: プロジェクト初期設計

### コンテキスト

TikTok動画生成システムの起動方法として、以下の選択肢があった：
1. 完全自動化（cron/スケジューラー）
2. 手動実行トリガー
3. イベント駆動（Webhook等）

### 決定事項

Phase 1では**手動実行トリガー**を採用する。

### 結果

**メリット**:
- 実装が最もシンプル
- コスト管理が容易（意図しない大量実行を防止）
- デバッグが容易
- Phase 1の検証に最適

**デメリット**:
- スケーラビリティが制限される
- 人的介入が必要

### 代替案

- **cron自動化**: 将来的にPhase 4で検討（docs/CLAUDE.md参照）
- **イベント駆動**: 複雑性が高すぎる

### 将来的な見直し

Phase 4（スケジューリング機能）で自動化を検討する。

---

## ADR-002: マルチプロバイダー対応アーキテクチャ

**ステータス**: 承認済み
**日付**: 2026-01-05
**決定者**: プロジェクト初期設計

### コンテキスト

AI生成機能（LLM、音声合成、画像生成、動画生成）において、以下の課題があった：
- プロバイダーのダウンタイムリスク
- 価格変動への対応
- 品質比較の必要性

### 決定事項

**すべてのAI機能でマルチプロバイダー対応**を実装する。

#### 対応プロバイダー

| 機能 | プロバイダー |
|------|-------------|
| LLM | OpenAI GPT-5.2, Claude 4.0 Sonnet |
| 音声合成 | ElevenLabs, OpenAI TTS, Google TTS |
| 画像生成 | DALL-E 3, Stable Diffusion 3.5 |
| 動画生成AI | Veo 3.1, Sora 2, Kling, Runway, Pika, Stable Video |

### 結果

**メリット**:
- 冗長性の確保（1つのプロバイダー障害時に切替可能）
- コスト最適化（価格比較が容易）
- 品質比較が可能
- ベンダーロックインの回避

**デメリット**:
- 実装複雑性の増加
- 各プロバイダーのAPIキー管理が必要
- テスト工数が増加

### 実装方針

- 抽象基底クラス（ABC）でインターフェース統一
- `config/providers.yaml` で切替可能
- Factory パターンでプロバイダー生成

**参考**: CLAUDE-patterns.md - Pattern 7

---

## ADR-003: PostgreSQL データベースの選定

**ステータス**: 承認済み
**日付**: 2026-01-05
**決定者**: プロジェクト初期設計

### コンテキスト

動画メタデータ、物語、生成履歴を永続化するデータベースの選定。

### 決定事項

**PostgreSQL 14+** を採用する。

### 結果

**メリット**:
- JSONB型でメタデータ保存が柔軟
- UUID型のネイティブサポート
- トランザクション保証
- 成熟したエコシステム（SQLAlchemy、Alembic）
- Dockerで簡単にセットアップ可能

**デメリット**:
- 小規模プロジェクトにはオーバースペック
- メモリ消費量が多い

### 代替案

- **SQLite**: 単一ファイルで簡単だが、同時実行性が低い
- **MySQL**: PostgreSQLと同等だが、JSONB型が弱い
- **MongoDB**: NoSQLだが、リレーショナルデータに不向き

**参考**: docs/DATABASE_DESIGN.md

---

## ADR-004: 手順書ベースのAIエージェント設計

**ステータス**: 承認済み
**日付**: 2026-01-05
**決定者**: プロジェクト初期設計

### コンテキスト

AIエージェントの動作ロジックをどのように定義するか。

### 決定事項

AIエージェントは**外部手順書（Markdown）を参照**して動作する。

#### 手順書ファイル
- `docs/information-gathering.md` - 情報収集手順
- `docs/story-creation.md` - 物語生成手順

### 結果

**メリット**:
- プロンプトとコードを分離（修正が容易）
- 非エンジニアでも手順書を編集可能
- バージョン管理が容易（Git）
- 手順書の改善履歴を追跡可能

**デメリット**:
- 手順書とコードの同期が必要
- 手順書の形式に依存

### 実装方針

```python
with open('docs/information-gathering.md') as f:
    procedure = f.read()

prompt = f"{procedure}\n\nテーマ: {theme}"
story = llm_provider.generate_story(prompt)
```

### 代替案

- **ハードコードプロンプト**: 柔軟性が低い
- **データベース保存**: 複雑性が高い

---

## ADR-005: Docker優先ワークフロー

**ステータス**: 承認済み
**日付**: 2026-01-05
**決定者**: プロジェクト初期設計

### コンテキスト

開発環境とデプロイ方法の選定。

### 決定事項

**Docker/Docker Compose を優先**したワークフローを採用する。

### 結果

**メリット**:
- 環境の一貫性（開発 = 本番）
- 依存関係の隔離（FFmpeg、PostgreSQL等）
- セットアップが容易
- ポータビリティが高い

**デメリット**:
- Docker知識が必要
- オーバーヘッド（特にmacOS）

### 実装方針

```yaml
# docker-compose.yml
services:
  app:
    build: .
    depends_on:
      - db
  db:
    image: postgres:14
```

### 代替案

- **venv + ローカルインストール**: Dockerが使えない環境用に併用可能

---

## ADR-006: Python 3.11+ の採用

**ステータス**: 承認済み
**日付**: 2026-01-05
**決定者**: プロジェクト初期設計

### コンテキスト

プログラミング言語とバージョンの選定。

### 決定事項

**Python 3.11以上**を採用する。

### 結果

**メリット**:
- AI/ML エコシステムが充実（OpenAI SDK、Anthropic SDK等）
- MoviePy、FFmpegのバインディングが豊富
- 型ヒント（Type Hints）のサポートが強化（3.11+）
- パフォーマンス向上（3.11は3.10比で10-60%高速）

**デメリット**:
- 古いシステムでは利用不可
- 一部のライブラリが未対応の可能性

### 代替案

- **Node.js/TypeScript**: AI SDKが弱い
- **Go**: 動画処理ライブラリが少ない

---

## ADR-007: SQLAlchemy ORM の採用

**ステータス**: 承認済み
**日付**: 2026-01-05
**決定者**: プロジェクト初期設計

### コンテキスト

PostgreSQLとの接続に使用するORM/ライブラリの選定。

### 決定事項

**SQLAlchemy 2.x** を採用する。

### 結果

**メリット**:
- タイプセーフなDB操作
- マイグレーション（Alembic）との統合
- リレーション管理が容易
- Pythonエコシステムで最も成熟

**デメリット**:
- 学習曲線が高い
- 生SQLより冗長

### 代替案

- **Django ORM**: フレームワーク全体が必要（オーバーキル）
- **Peewee**: シンプルだが、機能が限定的
- **asyncpg**: async専用（現時点では不要）

**参考**: CLAUDE-patterns.md - Pattern 5, 6

---

## ADR-008: YAML設定ファイルの使用

**ステータス**: 承認済み
**日付**: 2026-01-05
**決定者**: プロジェクト初期設計

### コンテキスト

AIプロバイダーや動画設定を管理する方法の選定。

### 決定事項

**YAML形式の設定ファイル**を使用する。

#### 設定ファイル
- `config/providers.yaml` - AIプロバイダー設定
- `config/video_settings.yaml` - 動画生成設定

### 結果

**メリット**:
- 可読性が高い（コメント可能）
- 階層構造が表現しやすい
- Gitで管理可能
- シークレット（APIキー）と分離

**デメリット**:
- YAML解析ライブラリが必要
- インデントエラーのリスク

### 実装例

```yaml
# config/providers.yaml
llm:
  active: openai  # or 'claude'
  openai:
    model: gpt-5.2
    temperature: 0.7
  claude:
    model: claude-4.0-sonnet
    temperature: 0.7

video:
  active: veo  # or 'sora', 'kling', etc.
  veo:
    model: veo-3.1
    resolution: "1080x1920"
```

### 代替案

- **JSON**: コメント不可、可読性が低い
- **TOML**: Pythonでの採用が増えているが、YAMLより馴染みが薄い
- **.env**: 階層構造に不向き（シークレット専用とする）

**参考**: CLAUDE-patterns.md - Pattern 2

---

## 🔄 ADR更新プロセス

新しいアーキテクチャ決定が必要になったら：

1. ADR番号を連番で付与
2. ADRフォーマットに従って記述
3. 関連するCLAUDE-patterns.mdのPatternを参照
4. CLAUDE-activeContext.mdに重要な決定として記載

---

## 📚 関連ドキュメント

- **CLAUDE-patterns.md** - コードパターンと規約
- **CLAUDE-activeContext.md** - 現在のプロジェクト状態
- **DATABASE_DESIGN.md** - データベース設計
- **CLAUDE.md** - AIエージェント向けハンドブック

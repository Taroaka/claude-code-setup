name: Automated Code Review

on:
  pull_request:
    branches: [ main, develop ]

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        run: |
          echo "files<<EOF" >> $GITHUB_OUTPUT
          git diff --name-only origin/${{ github.base_ref }}...${{ github.head_ref }} >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Generate review report
        id: review
        run: |
          echo "## ðŸ“ Automated Code Review" > review_report.md
          echo "" >> review_report.md
          echo "**PR**: #${{ github.event.pull_request.number }}" >> review_report.md
          echo "**Branch**: \`${{ github.head_ref }}\` â†’ \`${{ github.base_ref }}\`" >> review_report.md
          echo "" >> review_report.md

          echo "### ðŸ“„ Changed Files" >> review_report.md
          echo "\`\`\`" >> review_report.md
          echo "${{ steps.changed-files.outputs.files }}" >> review_report.md
          echo "\`\`\`" >> review_report.md
          echo "" >> review_report.md

          echo "### ðŸ” Review Checklist" >> review_report.md
          echo "" >> review_report.md
          echo "ã“ã®PRã¯ä»¥ä¸‹ã®è‡ªå‹•ãƒã‚§ãƒƒã‚¯ã‚’é€šéŽã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™:" >> review_report.md
          echo "" >> review_report.md
          echo "- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ï¼ˆsecurity-check.ymlï¼‰" >> review_report.md
          echo "- [ ] Python Lintingï¼ˆlint-python.ymlï¼‰" >> review_report.md
          echo "- [ ] æ‰‹å‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼ˆworkflow/review-template.mdä½¿ç”¨ï¼‰" >> review_report.md
          echo "" >> review_report.md

          echo "### ðŸ“‹ æŽ¨å¥¨äº‹é …" >> review_report.md
          echo "" >> review_report.md
          echo "1. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯**: è‡ªå‹•ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ã‚­ãƒ£ãƒ³ãŒå®Œäº†ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª" >> review_report.md
          echo "2. **Linting**: Ruffã€Blackã€mypyãŒãƒ‘ã‚¹ã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª" >> review_report.md
          echo "3. **æ‰‹å‹•ãƒ¬ãƒ“ãƒ¥ãƒ¼**: \`workflow/review-template.md\`ã‚’ä½¿ç”¨ã—ã¦è©³ç´°ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’å®Ÿæ–½" >> review_report.md
          echo "4. **ãƒ†ã‚¹ãƒˆ**: å¤‰æ›´ã«å¯¾ã™ã‚‹ãƒ†ã‚¹ãƒˆãŒå«ã¾ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèª" >> review_report.md
          echo "" >> review_report.md

          echo "### âš ï¸ æ³¨æ„äº‹é …" >> review_report.md
          echo "" >> review_report.md
          echo "- **Blocker**ãƒ¬ãƒ™ãƒ«ã®å•é¡Œã¯å¿…ãšä¿®æ­£ã—ã¦ãã ã•ã„" >> review_report.md
          echo "- **High**ãƒ¬ãƒ™ãƒ«ã®å•é¡Œã¯å„ªå…ˆçš„ã«ä¿®æ­£ã—ã¦ãã ã•ã„" >> review_report.md
          echo "- **.env**ãƒ•ã‚¡ã‚¤ãƒ«ã‚„**APIã‚­ãƒ¼**ãŒå«ã¾ã‚Œã¦ã„ãªã„ã‹ç¢ºèªã—ã¦ãã ã•ã„" >> review_report.md
          echo "" >> review_report.md

          echo "---" >> review_report.md
          echo "*ã“ã® Review ã¯ GitHub Actions ã«ã‚ˆã£ã¦è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ*" >> review_report.md

      - name: Comment PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const reviewReport = fs.readFileSync('review_report.md', 'utf8');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: reviewReport
            });

      - name: Review summary
        run: |
          echo "âœ… Review report generated and posted to PR"
          cat review_report.md
